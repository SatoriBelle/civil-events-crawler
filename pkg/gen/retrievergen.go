// Package gen contains all the components for code generation.
package gen

const retrieverTmpl = `
// Code generated by 'gen/watchergen'  DO NOT EDIT.
// IT SHOULD NOT BE EDITED BY HAND AS ANY CHANGES MAY BE OVERWRITTEN
// Please reference 'listener/watchergen' for more details
// File was generated at {{.GenTime}}
package {{.PackageName}}

import (
    log "github.com/golang/glog"
    "fmt"

    "github.com/ethereum/go-ethereum/accounts/abi/bind"
    "github.com/ethereum/go-ethereum/common"

    "github.com/joincivil/civil-events-crawler/pkg/model"
{{if .ContractImportPath -}}
    "{{.ContractImportPath}}"
{{- end}}
{{if .AdditionalImports -}}
{{- range .AdditionalImports}}
    "{{.}}"
{{- end}}
{{- end}}
)

// Retrieve{{.ContractTypeName}}Events retrieves events for {{.ContractTypeName}}
func Retrieve{{.ContractTypeName}}Events(client bind.ContractBackend, contractAddress common.Address, pastEvents *[]model.CivilEvent, startBlock uint64) error {
    contract, err := {{.ContractTypePackage}}.New{{.ContractTypeName}}(contractAddress, client)
    if err != nil {
        log.Errorf("Error initializing Start{{.ContractTypeName}}: err: %v", err)
        return err
    }

    var opts = &bind.FilterOpts{
        Start: startBlock,
    }

{{if .EventHandlers -}}
{{- range .EventHandlers}}

    err = Retrieve{{.EventMethod}}(opts, contract, pastEvents)
    if err != nil {
        return fmt.Errorf("Error retrieving {{.EventMethod}}: err: %v", err)
    }

{{- end}}
{{- end}}

    return nil
}

{{if .EventHandlers -}}
{{- range .EventHandlers}}

func Retrieve{{.EventMethod}}(opts *bind.FilterOpts, _contract *{{$.ContractTypePackage}}.{{$.ContractTypeName}}, pastEvents *[]model.CivilEvent) error {
    itr, err := _contract.Filter{{.EventMethod}}(
        opts,
    {{- if .ParamValues -}}
    {{range .ParamValues}}
        []{{.Type}}{},
    {{- end}}
    {{end}}
    )
    if err != nil {
        log.Errorf("Error getting event {{.EventMethod}}: %v", err)
        return err
    }
    nextEvent := itr.Next()
    for nextEvent {
        civilEvent := model.NewCivilEvent("{{.EventMethod}}", itr.Event)
        *pastEvents = append(*pastEvents, *civilEvent)
        nextEvent = itr.Next()
    }
    return nil
}

{{- end}}
{{- end}}
`
